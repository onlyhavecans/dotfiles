#!/bin/bash
## Using system /bin/bash is intentional. The script crashes when brew upgrades bash

function status_message {
  GREEN='\033[0;32m'
  NOCOLOR='\033[0m'
  echo -e "${GREEN}~ $*${NOCOLOR}"
}

status_message "Update castles"
# Needed for commands to work
# shellcheck source=/dev/null
source "${HOME}/.homesick/repos/homeshick/homeshick.sh"
homeshick pull
homeshick link
homeshick check

status_message "Update my brew packages"
brew update
brew upgrade
brew bundle install --global
brew completions link # https://docs.brew.sh/Shell-Completion

if command -v asdf &> /dev/null; then
  status_message "Update my asdf globals"
  asdf update
  asdf plugin update --all

  status_message "Update default python packages"
  python3 -m pip install --upgrade pip
  while read -r package; do
    python3 -m pip install --upgrade --quiet "$package"
  done < ~/.default-python-packages

  status_message "Update default ruby packages"
  while read -r package; do
    gem install --user --quiet "$package"
  done < ~/.default-gems

  status_message "Listing asdf installed versions"
  asdf reshim
  asdf list
fi

if [[ -x "${HOME}/.cargo/bin/rustup" ]]; then
  status_message "Update rust"
  "${HOME}/.cargo/bin/rustup" update
fi

if [[ -x "${HOME}/.tmux/plugins/tpm/bin/update_plugins" ]]; then
  status_message Update and clean tmux plugins
  ~/.tmux/plugins/tpm/bin/install_plugins
  ~/.tmux/plugins/tpm/bin/update_plugins all
  ~/.tmux/plugins/tpm/bin/clean_plugins
fi

status_message "Check for missing packages"
brew missing

status_message "Do I have any outdated App Store apps"
mas outdated
