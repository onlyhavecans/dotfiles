if has('vim_starting')
  if &compatible
    set nocompatible
  endif
  if &shell =~# 'fish$'   "This is a compatibility fix for fish-shell and plugins
    set shell=sh
  endif

  let g:python_host_prog = '/usr/local/bin/python'
  let g:python3_host_prog = '/usr/local/bin/python3'
endif

" ==== vim plug
if empty(glob('~/.vim/autoload/plug.vim'))
  silent !curl -fLo ~/.vim/autoload/plug.vim --create-dirs
    \ https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  autocmd VimEnter * PlugInstall | source $MYVIMRC
endif

call plug#begin('~/.vim/plugged')

Plug 'vim-airline/vim-airline'        " I like being on the airline
Plug 'vim-airline/vim-airline-themes' " my theme is here
Plug 'christoomey/vim-tmux-navigator' " Seamless vim & tmux nav with C-hjkl
Plug 'tpope/vim-surround'             " cs\" and cs' for surrounding
Plug 'tpope/vim-obsession'            " ,o to obsess
Plug 'godlygeek/tabular'              " Text Alignment plugin (needed for plasticboy/vim-markdown)
Plug 'tomtom/tcomment_vim'            " Auto block commenting
Plug 'junegunn/vim-easy-align', { 'on': ['<Plug>(EasyAlign)', 'EasyAlign'] } " Text Alignment plugin
"  Autocomplete?
if has('nvim')
  Plug 'Shougo/deoplete.nvim', { 'do': ':UpdateRemotePlugins' }
  Plug 'nsf/gocode', { 'for': 'go', 'rtp': 'nvim', 'do': '~/.config/nvim/plugged/gocode/nvim/symlink.sh'  } "req for deoplete-go
  Plug 'zchee/deoplete-go', { 'for': 'go', 'do': 'make'} " Go Completion
  Plug 'autozimu/LanguageClient-neovim', { 'do': ':UpdateRemotePlugins' }
  Plug 'Shougo/neco-vim' " vim-script comletion
  Plug 'fishbullet/deoplete-ruby', { 'for': 'ruby' }
  Plug 'Shougo/echodoc.vim'
  Plug 'wellle/tmux-complete.vim'
endif
Plug 'junegunn/fzf', { 'dir': '~/.fzf', 'do': './install --all' } " Fastest finding
Plug 'junegunn/fzf.vim'
Plug 'tpope/vim-fugitive'     " How you use git as a vim user
Plug 'tpope/vim-git'          " gitfiles editing
Plug 'airblade/vim-gitgutter' " Shows edits from git in gutter
Plug 'blueyed/delimitMate'    " Autoadding closing braces
Plug 'janko-m/vim-test'       " TDD better
Plug 'jgdavey/tslime.vim'     " Spawn test in a tmux pane
Plug 'jremmen/vim-ripgrep'    " Ripgrep's time has come
Plug 'tmux-plugins/vim-tmux'  " Tmux fletype
Plug 'dougireton/vim-chef'    " Sets filetypes with chef and sets path to make `gf` work with recipes
Plug 'dag/vim-fish'           " Fish is my shell
Plug 'fatih/vim-go', { 'for': 'go' }
Plug 'rust-lang/rust.vim', { 'for': 'rust' }
Plug 'timonv/vim-cargo', { 'for': 'rust' }
Plug 'racer-rust/vim-racer', { 'for': 'rust' }
Plug 'klen/python-mode'
Plug 'junegunn/goyo.vim'                              " Text writing view
Plug 'junegunn/limelight.vim'                         " Text writing highlight
Plug 'plasticboy/vim-markdown', { 'for': 'markdown' } " Markdown
Plug 'itspriddle/vim-marked', { 'for': 'markdown' }   " Opens Marked 2 on current file
Plug 'baskerville/bubblegum'                          " light terminal color scheme
Plug 'scrooloose/syntastic'
Plug 'rizzatti/dash.vim'

" My special plugins
Plug 'onlyhavecans/mm.vim'

call plug#end()

" === Colorscheme
set background=dark
 colorscheme bubblegum-256-dark

" ==== make nvim less annoyting
if has('nvim')
  tnoremap jk <C-\><C-n>
  tnoremap kj <C-\><C-n>
  set clipboard+=unnamedplus
endif

" ==== General sanity fixing
set encoding=utf-8
set fileencoding=utf-8
syntax enable
filetype plugin indent on
set backspace=indent,eol,start  "Allow backspace in insert mode
set list listchars=tab:→\ ,trail:∙,nbsp:+ " Display tabs and trailing spaces visually
set incsearch "Find the next match as we type the search
set nrformats= " blank nrf to make ^a always binary
set noswapfile
set nobackup
set nowritebackup
set autoindent
set smartindent
set smarttab
set shiftwidth=2
set softtabstop=2
set tabstop=2
set expandtab
set nowrap
set linebreak " Wrap lines at convenient points
set nofoldenable "no fold by default ever
set foldmethod=indent
set wildmode=list:longest,full
set wildmenu                "enable ctrl-n and ctrl-p to scroll thru matches

" ==== Persistent Undo
" Keep undo history across sessions, by storing in file.
" Only works all the time.
let backupdir = expand('~/.vim/backups')
if !isdirectory(backupdir)
  call mkdir(backupdir)
endif
set undodir=~/.vim/backups
set undofile

" ==== Scrolling
set scrolloff     =8         "Start scrolling when we're 8 lines away from margins
set sidescrolloff =15
set sidescroll    =1
" Resize splits when the window is resized
au VimResized * exe "normal! \<c-w>="


" ================ My Cool shortcuts
let mapleader   = ","
let g:mapleader = ","

" <F1> = Disable help
nnoremap <F1> <nop>

" <F2> = Toggle line numbers
nnoremap <F2> :set nonumber!<CR>:set foldcolumn=0<CR>

" <F3> = None
" nnoremap <F3> <nop>

" <F4> = Empty

" <F5> = Empty

" <F6> = change directory to current file's pwd
nnoremap <F6> :cd %:p:h<CR>:pwd<CR>

" <F7> = Toggle paste mode
set pastetoggle=<F7>

" <F8> = next buffer

" <F9> = None
" nmap <F9> <nop>

" // = clears search highlight
nnoremap <silent> // :noh<CR>

nnoremap XX :qall!<CR>

" K = Disable man key
nnoremap K <nop>

" jk smash = esc! Seriously, esc on the homerow
inoremap jk <Esc>
inoremap kj <Esc>

" Y = copy from current character to end of line
" (mimic y0's behavior but backwards)
noremap Y y$

" Start interactive EasyAlign in visual mode (e.g. vip<Enter>)
vmap <Enter> <Plug>(EasyAlign)
" Start interactive EasyAlign for a motion/text object (e.g. <Leader>aip)
nmap <Leader>a <Plug>(EasyAlign)

" <Leader>a = Tab by following character
nnoremap <Leader>a= :Tabularize /=<CR>
vnoremap <Leader>a= :Tabularize /=<CR>
nnoremap <Leader>a: :Tabularize /:\zs<CR>
vnoremap <Leader>a: :Tabularize /:\zs<CR>
nnoremap <Leader>a. :Tabularize /=><CR>
vnoremap <Leader>a. :Tabularize /=><CR>
vnoremap <Leader>ad :Tabularize /\d<CR>
nnoremap <Leader>ad :Tabularize /\d<CR>
vnoremap <Leader>as :Tabularize /^\s*\S\+\s\s\+\zs<CR>
nnoremap <Leader>as :Tabularize /^\s*\S\+\s\s\+\zs<CR>

" <Leader>b = blagfix (strip curlies)
nnoremap <Leader>b :StraightenQuotes<CR>

" <Leader>c = comment out
vnoremap <Leader>c :TComment<CR>
nnoremap <Leader>c :TComment<CR>

" <Leader>d (or ,dd or ,dj or 20,dd) to delete a line without adding it to the
" yanked stack (also, in visual mode)
nnoremap <silent> <leader>d "_d
xnoremap <silent> <leader>d "_d

" <Leader>D = Dash Search for current word
nmap <silent> <leader>D <Plug>DashSearch

" <Leader>e = open vimrc in a split for quick editing
nnoremap <leader>e :tabnew $MYVIMRC<cr>

" <Leader>f = toggle all folding
noremap <Leader>f zi

" <Leader>h = Highlight changed lines using Git Gutter
noremap <Leader>h :GitGutterLineHighlightsToggle<CR>

" <Leader>o = Start 0bsessing
noremap <Leader>o :Obsess<CR>

" <Leader>p = paste at end of line
inoremap <Leader>p :normal $p
nnoremap <Leader>p $p

" <Leader>P = paste in next line
inoremap <Leader>P :normal pu<CR>
nnoremap <Leader>P :pu<CR>

" <Leader>t = test
nmap <silent> <leader>t :TestSuite<CR>

" <Leader>q = Auto rewrap
vnoremap <Leader>q gq
nnoremap <Leader>q gqap

" <Leader>r = Reload vim config
noremap <Leader>r :so $MYVIMRC<CR>

" <Leader>s = Search under word in my current search obsession
noremap <Leader>s :Rg<CR>

" <Leader>w = Strip all whitespace (from yadr-whitespace-killer.vim)
nnoremap <Leader>w :StripTrailingWhitespaces<CR>

" <Leader>z = quick write/save
nnoremap <Leader>z :write<CR>

" :w!! = write a file as sudo
cmap w!! w !sudo tee % >/dev/null

" :Q = quit all fast
command! -nargs=0 Quit :qall!

" ==== deoplete
let g:tmuxcomplete#trigger = ''
if has('nvim')
  let g:deoplete#enable_at_startup = 1
endif

" ==== vim-markdown
let g:vim_markdown_folding_disabled=1
function! SetMarkdownOptions()
  Limelight
  Wrap
endfunction
autocmd! User GoyoEnter call SetMarkdownOptions()
autocmd! User GoyoLeave Limelight!

" ==== Plug
let g:plug_window = 'tabnew'

" ==== airline
let g:airline_powerline_fonts = 1
let g:airline_theme='bubblegum'
let g:airline#extensions#tabline#enabled = 0
let g:airline#extensions#whitespace#enabled = 1

" ==== GitGutter
let g:gitgutter_realtime = 0
let g:gitgutter_eager    = 0

" ==== Syntastic
let g:syntastic_always_populate_loc_list = 1
let g:syntastic_auto_loc_list = 1
let g:syntastic_check_on_open = 1
let g:syntastic_check_on_wq = 0

let g:syntastic_enable_signs=1
let g:syntastic_aggregate_errors = 1
let g:syntastic_ignore_files=['\m^/opt/chefdk/']

" ==== Powerline
set laststatus=2

" ==== delimitMate
let delimitMate_expand_space = 1
let delimitMate_expand_cr    = 2

" ==== Dash
let g:dash_map = { 'ruby.chef' : 'chef' }

" ==== vim-test
"  make test commands execute using vim-test
let test#strategy = "tslime"

" ==== vim-tmux-navigator
let g:tmux_navigator_disable_when_zoomed = 1

" ==== Ripgrep
if executable("rg")
    set grepprg=rg\ --vimgrep\ --no-heading
    set grepformat=%f:%l:%c:%m,%f:%l:%m
endif

" ==== RLS
let g:rustfmt_autosave = 1

let g:LanguageClient_serverCommands = {
    \ 'rust': ['rustup', 'run', 'nightly', 'rls'],
    \ }

" Automatically start language servers.
let g:LanguageClient_autoStart = 1

nnoremap <silent> K :call LanguageClient_textDocument_hover()<CR>
nnoremap <silent> gd :call LanguageClient_textDocument_definition()<CR>
nnoremap <silent> <F2> :call LanguageClient_textDocument_rename()<CR>

" ==== Srtraighten Quotes
function! <SID>StraightenQuotes()
    " Preparation: save last search, and cursor position.
    let _s=@/
    let l = line(".")
    let c = col(".")
    " Do the business:
    %s/[”“„]/"/g
    %s/[`’‘]/'/g
    %s/[…]/.../g
    " Clean up: restore previous search history, and cursor position
    let @/=_s
    call cursor(l, c)
endfunction

command! StraightenQuotes call <SID>StraightenQuotes()

" ==== Strip trailing whitespace
" http://rails-bestpractices.com/posts/60-remove-trailing-whitespace
function! <SID>StripTrailingWhitespaces()
    " Preparation: save last search, and cursor position.
    let _s=@/
    let l = line(".")
    let c = col(".")
    " Do the business:
    %s/\s\+$//e
    " Clean up: restore previous search history, and cursor position
    let @/=_s
    call cursor(l, c)
endfunction

command! StripTrailingWhitespaces call <SID>StripTrailingWhitespaces()

" ==== Super wrapping power
" http://vimcasts.org/episodes/soft-wrapping-text/
function! SetupWrapping()
  set wrap linebreak nolist
  set showbreak=…
endfunction

command! -nargs=* Wrap :call SetupWrapping()

" ==== Sourcing plugin specific setting
if filereadable(glob("~/.vimrc.local"))
  source ~/.vimrc.local
endif

" ==== local .vimrc with .envrc using add_extra_vimrc
if exists("$EXTRA_VIM")
  for path in split($EXTRA_VIM, ':')
    exec "source ".path
  endfor
endif

if has("gui_vimr")
  set termguicolors
  source ~/.gvimrc
endif
